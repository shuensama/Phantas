# Phantas 功能规格说明书

本文档旨在详细定义 Phantas 应用的核心功能、用户流程和技术规格。

## 1. 项目概述

Phantas 是一个为长篇小说作者设计的 AI 插图生成工具。其核心目标是解决在长篇叙事中，AI 生成图像时角色与风格难以保持一致的痛点。用户可以通过创建小说项目、管理角色视觉设定，来为特定场景生成高质量且风格统一的插图。

## 2. 核心功能

- **小说项目管理**: 创建和管理独立的小说项目。
- **角色一致性管理**: 为每个小说项目创建和维护角色库，确保角色视觉特征的统一。
- **场景图像生成**: 根据场景描述和指定的角色，生成符合小说整体风格的插图。
- **灵活的 API 支持**: 支持从云端 AI 服务无缝切换到本地部署的 AI 绘画接口。

## 3. 用户故事

- **作为一名小说作者**，我希望能为我的小说创建一个独立的项目空间，以便于管理与这部作品相关的所有角色和插图。
- **作为一名小说作者**，我希望能够详细定义并保存我笔下主要角色的外貌特征，以便在生成不同场景的插图时，AI 能够保持角色形象的一致性。
- **作为一名小说作者**，我希望能输入一段场景描述，并选择一或多个已定义的角色，快速生成一张高质量的插图，以便将文字内容视觉化。
- **作为一名拥有本地计算资源的用户**，我希望能将应用连接到我自己在本地部署的 Stable Diffusion 服务，以便利用本地 GPU 进行更快、更自由的图像生成，同时保护数据隐私。
- **作为一名追求特定艺术风格的作者**，我希望能设定整个小说项目的整体艺术风格（例如，“日系动画风格”、“写实油画风格”），以便所有生成的插图都遵循统一的视觉美学。

## 4. 功能详述

### 4.1. 小说项目管理

**目的**: 为用户提供一个容器来组织与单部小说相关的所有资源，包括角色、场景、插图和设定。

**功能点**:

1.  **创建小说项目**:
    -   用户可以在主界面点击“创建新小说”按钮。
    -   弹出一个表单，要求用户输入以下信息：
        -   `标题` (必填): 小说的名称。
        -   `简介` (可选): 对小说的简短描述。
        -   `全局风格描述` (可选): 定义整个项目的默认艺术风格的描述词，例如 "masterpiece, best quality, anime style, clean lines, vibrant colors"。

2.  **查看小说列表**:
    -   在主界面，以卡片的形式展示用户创建的所有小说项目。
    -   每个卡片上应显示小说的标题和简介。

3.  **进入项目详情**:
    -   点击小说卡片后，用户会进入该小说的专属工作区，后续的角色管理和图像生成都将在此空间内进行。

4.  **编辑与删除**:
    -   在小说卡片或项目详情页中，应提供编辑和删除该项目的选项。

### 4.2. 角色管理

**目的**: 允许用户为其小说创建详细的角色设定卡，并将这些设定转化为可供 AI 理解的、结构化的描述词 (Tags)，以确保角色在不同场景下的视觉一致性。

**功能点**:

1.  **创建角色**:
    -   在小说项目的工作区内，用户可以点击“添加新角色”按钮。
    -   系统会呈现一个结构化的表单，而不是一个简单的文本框，用于输入角色的外貌信息。这个表单可能包含以下字段：
        -   `姓名` (必填): 角色名称。
        -   `核心外貌描述` (必填): 一段简短的、用于在生成 prompt 时**总是**包含的、最关键的外貌描述。例如: `1girl, silver hair, blue eyes, black leather jacket`。
        -   `发型`: (下拉菜单或标签输入) 如 `long hair`, `ponytail`, `short bob`。
        -   `发色`: (颜色选择器或标签输入) 如 `blonde hair`, `dark brown hair`。
        -   `眼睛颜色`: (颜色选择器或标签输入) 如 `green eyes`, `golden eyes`。
        -   `服装`: (文本区域) 输入角色在该场景下的默认或常见服装。
        -   `其他特征`: (标签输入) 用于添加更多细节，如 `elf ears`, `wearing glasses`, `scar on left cheek`。

2.  **角色列表**:
    -   在项目工作区内，以“角色卡片”的形式展示所有已创建的角色。
    -   每张卡片上应显示角色的姓名和一个预览图（初期可以是默认图标，后期可以是生成的标准像）。

3.  **编辑与删除**:
    -   用户可以随时编辑或删除已有的角色卡片。

**核心机制**: 当用户选择一个角色用于场景生成时，系统会自动将这些结构化的字段组合成一段高质量的 prompt tag，并将其与场景描述结合。例如，选择一个角色可能会自动添加 `(silver hair:1.2), (blue eyes:1.1), long hair, ponytail` 这样的描述到最终的 prompt 中。

### 4.3. 图像生成流程

**目的**: 提供一个直观的界面，让用户可以轻松地将场景描述、角色选择和风格设定结合起来，生成符合预期的插图。

**界面与流程**:

1.  **生成界面**:
    -   在小说项目的工作区内，会有一个专门的“场景生成”区域。
    -   这个区域主要由以下几个部分构成：
        -   **场景描述输入框**: 一个大的文本区域，用户可以在此输入详细的场景描述，例如 "在一个古老的图书馆里，阳光从彩色玻璃窗洒落进来"。
        -   **角色选择器**: 在输入框旁边或下方，以列表或卡片的形式展示该项目下的所有角色。用户可以勾选一或多个需要出现在场景中的角色。
        -   **高级选项 (可选折叠)**:
            -   `负面提示 (Negative Prompt)`: 用户可以输入不希望在画面中出现的内容。
            -   `图像尺寸`、`步数` 等 AI 绘画常用参数。
        -   **生成按钮**: 点击后开始生成图像。

2.  **Prompt 组合逻辑**:
    -   当用户点击“生成”时，后端系统会执行以下操作：
        1.  **起始 Prompt**: 使用小说项目设定的 `全局风格描述`。
        2.  **添加场景**: 将用户输入的 `场景描述` 添加进来。
        3.  **添加角色**: 对于每一个被选中的角色，系统会将其 `核心外貌描述` 和其他结构化字段组合成一段高质量的描述词，并添加到 Prompt 中。
        4.  **最终生成**: 将组合好的完整 Prompt 发送给 AI 绘画 API（无论是远程还是本地）。

3.  **结果展示**:
    -   生成的图片会显示在界面的一个专门区域。
    -   用户可以对生成的图片进行保存、删除或选择作为角色的“标准像”等操作。

## 5. 数据模型

为了支持上述功能，我们将设计以下两个核心数据表。

### 5.1. `novels` (小说表)

用于存储用户创建的每一个小说项目。

| 字段名                | 数据类型      | 描述                       | 约束/备注               |
| --------------------- | ------------- | -------------------------- | ------------------------- |
| `id`                  | Integer       | 唯一标识符                 | 主键, 自增              |
| `title`               | String(255)   | 小说标题                   | 非空                    |
| `description`         | Text          | 小说简介                   | 可为空                  |
| `global_style`        | Text          | 全局艺术风格描述词         | 可为空                  |
| `created_at`          | DateTime      | 创建时间                   | 自动生成                |
| `updated_at`          | DateTime      | 最后更新时间               | 自动更新                |

### 5.2. `characters` (角色表)

用于存储每个小说项目下的角色信息。

| 字段名                | 数据类型      | 描述                       | 约束/备注               |
| --------------------- | ------------- | -------------------------- | ------------------------- |
| `id`                  | Integer       | 唯一标识符                 | 主键, 自增              |
| `novel_id`            | Integer       | 所属小说的 ID              | 外键, 关联 `novels.id`  |
| `name`                | String(255)   | 角色姓名                   | 非空                    |
| `core_description`    | Text          | 核心外貌描述 (Prompt)      | 非空                    |
| `structured_features` | JSON          | 结构化的外貌特征           | 可为空, 存储 JSON 对象 |
| `created_at`          | DateTime      | 创建时间                   | 自动生成                |
| `updated_at`          | DateTime      | 最后更新时间               | 自动更新                |

**说明**: `structured_features` 字段将以 JSON 格式存储“角色管理”部分定义的结构化表单数据，例如 `{"hair_style": "long hair", "hair_color": "blonde", "eye_color": "blue"}`。

## 6. 技术实现方案

### 6.1. 技术栈回顾

-   **前端**: Next.js (React) + TypeScript + Tailwind CSS
-   **后端**: Python + FastAPI
-   **数据库**: PostgreSQL (使用 SQLAlchemy ORM)
-   **图像生成 API**:
    -   初期: 接入一个公开的、基于 Stable Diffusion 的云服务 API。
    -   后期: 支持用户配置本地 Stable Diffusion WebUI (如 AUTOMATIC1111) 的 API 地址。

### 6.2. 本地 API 支持方案

-   **配置界面**: 在应用的前端设置页面，提供一个输入框，允许用户填入其本地服务的地址（例如 `http://127.0.0.1:7860`）。
-   **后端代理**: 前端将生成请求（包括组合好的 Prompt 和参数）发送给我们的 FastAPI 后端。后端再根据用户的配置，将此请求转发给指定的本地 API 地址。
-   **优势**: 这样做可以避免浏览器的跨域安全问题，同时将 API key 等敏感信息保留在后端，增加了安全性。

### 6.3. 高级一致性技术路径 (未来展望)

-   **LoRA/DreamBooth 集成**:
    1.  **用户上传**: 用户可以上传多张已生成的、自己满意的角色图片。
    2.  **云端训练 (可选)**: 如果条件允许，可以提供一个云端训练服务，为用户微调一个专属的角色 LoRA 模型。
    3.  **本地训练**: 或者，提供详细的教程，引导用户如何在本地训练 LoRA 模型。
    4.  **模型应用**: 在图像生成时，用户可以选择加载并应用自己的 LoRA 模型，从而达到极高的人物一致性。
